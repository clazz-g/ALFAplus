---
title: "ADPD 2026 abstract"
author: "Clazz"
date: "2025-07-07"
output: html_document
---

```{r}
library(readxl)
#install.packages("ggplot2")
library(ggplot2)
#install.packages("psych")
library(psych)
#install.packages("tidyverse")
library(tidyverse)
#install.packages("ggpubr")
library(ggpubr)
#install.packages("broom")
library(broom)
#install.packages("ggeffects")
library(ggeffects)
#install.packages("MASS")
library(MASS)
#install.packages("mice")
library(mice)
#install.packages("VIM")
library(VIM)
#install.packages("car")
library(car)
#install.packages("sjPlot")
library(sjPlot)
#install.packages("caret")
library(caret)
#install.packages("bestNormalize")
library(bestNormalize)
#install.packages("ggrain")
library(ggrain)
#install.packages("emmeans")
library(emmeans)
#install.packages("skimr")
library(skimr)
library(glmnet)
#install.packages("bullseye")
library(bullseye)
#install.packages("lavaan")
library(lavaan)
#install.packages("brms")
library(brms)
#install.packages("mgcv")
library(mgcv)
library(splines)
#install.packages("fitdistrplus")
library(fitdistrplus)
#install.packages("patchwork")
library(patchwork)
#install.packages("lme4")
library(lme4)
#install.packages("lmerTest")
library(lmerTest)
#install.packages("MuMIn")
library(MuMIn)
```

# Read in data

reading in basic, biomarkers and mri dates

```{r, echo=FALSE}
data<-read_delim("G:/My Drive/Data/ALFA+/ALFA_dataset_basic.csv", 
    delim = ",", escape_double = FALSE, trim_ws = TRUE)

date_mri_v1<-read_excel("G:/My Drive/Data/ALFA+/neuroimaging/bx_scandates_ALFA_PLUS_V1_20231120_20250210_135308.xlsx")%>%
  dplyr::select(subject_label, scandate)%>%
  mutate(subject_label = as.numeric(subject_label))%>%
  rename(subject = subject_label,
         scandate_v1 = scandate)

date_mri_v2<-read_excel("G:/My Drive/Data/ALFA+/neuroimaging/bx_scandates_ALFA_PLUS_V2_20230518_20250210_135351.xlsx")%>%
  dplyr::select(subject_label, scandate)%>%
  mutate(subject_label = as.numeric(subject_label))%>%
  rename(subject = subject_label,
         scandate_v2 = scandate)

date_mri_long<-full_join(date_mri_v1, date_mri_v2)%>%
  mutate(scandate_v1 = as.Date(scandate_v1, format = "%Y-%m-%d"),
         scandate_v2 = as.Date(scandate_v2, format = "%Y-%m-%d"),
         diff_mri = as.numeric(difftime(scandate_v2, scandate_v1, units = c("days")))/365.25)

#adding MRI sessions dates to the dataset
data<-left_join(data, date_mri_long)%>%
  mutate(DOB = as.Date (DOB, format = "%Y-%m-%d"),
         age_v1_mri = as.numeric(difftime(scandate_v1, DOB, units= c("days")))/365.25,
         age_v2_mri = as.numeric(difftime(scandate_v2, DOB, units= c("days")))/365.25)

biomarkers<-read_delim("G:/My Drive/Data/ALFA+/biomarkers/biomarkers_CSF_processed.csv", 
    delim = ",", escape_double = FALSE, trim_ws = TRUE)%>%
  filter(Visit == "V1")%>%
  dplyr::select(-Visit)

data<-left_join(data, biomarkers)%>%
  mutate(A=factor(A),
         APOE_binary=factor(APOE_binary),
         HRT = factor(HRT))



```

# Cognitive results - LMM
without time interaction executive scores are significant
with time interaction the pacc scores are
## PACC
```{r, echo=FALSE}
#frist getting the time difference beteen cog tests
time_diff<-read_excel("G:/My Drive/Data/ALFA+/Cognition/PACCv1_to_v3(incomplete).xlsx")%>%
  dplyr::select(IdParticipante, Visit,FechaResultado)%>%
  rename(subject = IdParticipante)%>%
  mutate(subject = as.numeric(subject))%>%
  filter(Visit != 3)%>%
  pivot_wider(names_from = Visit, values_from = FechaResultado, names_prefix = c("Fecha_Resultado"))%>%
  mutate(time_diff = as.numeric(difftime(Fecha_Resultado2, Fecha_Resultado1, units= c("days"))))%>%
  dplyr::select(subject, time_diff)

cognition<-read_excel("G:/My Drive/Data/ALFA+/Cognition/PACCv1_to_v3(incomplete).xlsx")%>%
  dplyr::select(IdParticipante, Visit, Z_PACC, Z_FCSRTI_RT, Z_aWMS_DR_RS, Z_Wclave_totalscr, Z_FS_totalcnswr, FechaResultado)%>%
  rename(subject = IdParticipante)%>%
  mutate(subject = as.numeric(subject))

data_cog_long<- left_join(data, cognition)%>%
  mutate(age_cog = as.numeric(difftime(FechaResultado, DOB, units= c("days")))/365.25)%>%
  group_by(subject)%>%
  filter(Visit != 3) %>%
  filter(n()>=2)%>%
  relocate(Visit, .after=sex)%>%
  ungroup()%>%
  left_join(., time_diff)%>%
  mutate(time_diff = ifelse(Visit == 1, 0, time_diff))


fit_cog_simple<-lmer(Z_PACC ~ kids_total*time_diff +age_v1 + APOE_binary + education + A +(1 | subject), data_cog_long[data_cog_long$sex == 2,])
summary(fit_cog_simple)

fit_cog<-lmer(Z_PACC ~ kids_total*A*time_diff +age_v1 + APOE_binary + education +(1 | subject), data_cog_long[data_cog_long$sex == 2,])
summary(fit_cog)
plot_model(fit_cog, type = "int")

fit_cogA0<-lmer(Z_PACC ~ kids_total*time_diff +age_v1 + APOE_binary + education +(1 | subject), data_cog_long[data_cog_long$sex == 2 & data_cog_long$A==0,])
summary(fit_cogA0)
fit_cogA1<-lmer(Z_PACC ~ kids_total*time_diff +age_v1 + APOE_binary + education +(1 | subject), data_cog_long[data_cog_long$sex == 2 & data_cog_long$A==1,])
summary(fit_cogA1)

#using emmeans is better because of quite unequal group sizes

hist(data_cog_long$time_diff)


emm_int <- emmeans(fit_cog, ~ A | kids_total * time_diff,
                   at = list(kids_total = c(0, 1, 2, 3, 4),
                             time_diff = c(0, 500, 1000, 1500, 2000)),
                   data = data_cog_long[data_cog_long$sex == 2,])
pairs(emm_int)

emm_slopes <- emtrends(fit_cog, ~ A, var = "kids_total",
                   data = data_cog_long[data_cog_long$sex == 2,])
pairs(emm_slopes)


emm_slopes2 <- emtrends(fit_cog, ~ A, var = "time_diff",
                   data = data_cog_long[data_cog_long$sex == 2,])
pairs(emm_slopes2)

data_cog_long%>%
  filter(sex==2)%>%
  filter(A==0)%>%
  ggplot(aes(kids_total, Z_PACC ))+
  geom_point()+
  facet_wrap(~Visit)

```

## Composites
```{r, echo=FALSE}

composites1<-read_excel("G:/My Drive/Data/ALFA+/Cognition/Visit 1 - Cognition Z Scores.xlsx")%>%
  dplyr::select(-Gender, -Age_V1S1, -Years_Edu, -V1S1_dt, -Z_PACC_Composite_1.2._v1 )%>%
  rename(subject = IdParticipante,
         Z_Attention_Composite = Z_Attention_Composite_v1,
         Z_Memory_Composite = Z_Memory_Composite_v1,
         Z_Executive_Composite = Z_Executive_Composite_v1,
         Z_Language_Composite = Z_Language_Composite_v1,
         Z_Visual_Composite = Z_Visual_Composite_v1)%>%
  mutate(Visit = "1")

composites2<-read_excel("G:/My Drive/Data/ALFA+/Cognition/Visit 2 - Cognition Z Scores.xlsx")%>%
  dplyr::select(-Gender, -Age_V1S1, -Years_Edu, -V1S1_dt, -V2S1_dt, -Z_PACC_Composite_1.2._V2 )%>%
  rename(subject = IdParticipante,
         Z_Attention_Composite = Z_Attention_Composite_V2,
         Z_Memory_Composite = Z_Memory_Composite_V2,
         Z_Executive_Composite = Z_Executive_Composite_V2,
         Z_Language_Composite = Z_Language_Composite_V2,
         Z_Visual_Composite = Z_Visual_Composite_V2)%>%
  mutate(Visit = "2")

composite_all<-full_join(composites1, composites2)%>%
  group_by(subject) %>%
  ungroup()%>%
  mutate(subject = as.numeric(subject))

data_cog_long_composites<-left_join(data_cog_long, composite_all)%>%
  mutate(A= factor(A),
         APOE_binary = factor(APOE_binary))

#Cross sectional

fit_cog_domain<-lmer(Z_Visual_Composite ~ kids_total*A*time_diff +age_v1 + APOE_binary + education + (1 | subject), data_cog_long_composites[data_cog_long_composites$sex == 2,])
summary(fit_cog_domain)


```



# hippo vol change

```{r, echo=FALSE}
hippo<-read_excel("G:/My Drive/Data/ALFA+/neuroimaging/bx_freesurfer7_hippoSfVolumes_ALFA_PLUS_V1_20231120_20250208_111212.xlsx")%>%
  group_by(subject, region) %>%
  summarize(bilateral_volume = sum(value), .groups = "drop")%>%
 mutate(region = case_when(region == "CA1-body"| region == "CA1-head" ~ "CA1",
            region == "CA3-body"| region == "CA3-head" ~ "CA3",
            region == "CA4-body"| region == "CA4-head" ~ "CA4",
            region == "GC-ML-DG-body" | region == "GC-ML-DG-head" ~ "GC_ML_DG",
            region == "molecular_layer_HP-body" | region == "molecular_layer_HP-head"~ "molecular_layer_HP",
            region == "presubiculum-body" | region == "presubiculum-head" ~ "presubiculum",
            region == "subiculum-body" | region == "subiculum-head" ~ "subiculum",
            .default = region))%>%
  group_by(region, subject)%>%
  summarize( bilateral_volume = sum(bilateral_volume), .groups = "drop")%>%
  pivot_wider(names_from = region, values_from = bilateral_volume, names_prefix = "vol_")%>%
  mutate(subject = as.numeric(subject),
         Visit = "V1")

hippo_data<-left_join(data, hippo)

hippo2<-read_excel("G:/My Drive/Data/ALFA+/neuroimaging/bx_freesurfer7_hippoSfVolumes_ALFA_PLUS_V2_20230518_20250208_112459.xlsx")%>%
  group_by(subject, region) %>%
  summarize(bilateral_volume = sum(value), .groups = "drop")%>%
  mutate(region = case_when(region == "CA1-body"| region == "CA1-head" ~ "CA1",
            region == "CA3-body"| region == "CA3-head" ~ "CA3",
            region == "CA4-body"| region == "CA4-head" ~ "CA4",
            region == "GC-ML-DG-body" | region == "GC-ML-DG-head" ~ "GC_ML_DG",
            region == "molecular_layer_HP-body" | region == "molecular_layer_HP-head"~ "molecular_layer_HP",
            region == "presubiculum-body" | region == "presubiculum-head" ~ "presubiculum",
            region == "subiculum-body" | region == "subiculum-head" ~ "subiculum",
            .default = region))%>%
  group_by(region, subject)%>%
  summarize( bilateral_volume = sum(bilateral_volume), .groups = "drop")%>%
  pivot_wider(names_from = region, values_from = bilateral_volume, names_prefix = "vol_")%>%
  mutate(subject = as.numeric(subject),
         Visit = "V2")

hippo_data2<-left_join(data, hippo2)
  

hippo_data_long<-bind_rows(hippo_data, hippo_data2)%>%
  mutate(Visit = factor(Visit))%>%
  mutate(age_mri = case_when(
    Visit == "V1" ~ age_v1_mri,
    Visit == "V2" ~ age_v2_mri
  ))%>%
  dplyr::select(-age_v1_mri, -age_v2_mri)%>%
  drop_na(scandate_v2)%>%
  mutate(diff_mri = ifelse(Visit == "V1", 0, diff_mri))

#fucntion to run 
run_volume_lmer_regressions <- function(data, predictors) {
  # Find all columns that start with "vol_"
  outcome_vars <- grep("^vol_", names(data), value = TRUE)

  # Create a formula string from predictors
  predictor_formula <- paste(predictors, collapse = " + ")

  # Run regressions and store summary results
  summaries <- lapply(outcome_vars, function(outcome) {
    formula <- as.formula(paste0("`", outcome, "` ~ ", predictor_formula))
    model <- lmer(formula, data = data)
    summary(model)
  })

  # Name each summary by its outcome variable
  names(summaries) <- outcome_vars

  return(summaries)
}
```

## Whole hippocampus
```{r, echo=FALSE}
##no interaction
#introduced A as a covariate to test if number of kids is truly independent

mod_simple<-lmer(vol_Whole_hippocampus ~ kids_total*diff_mri*A + age_v1 +APOE_binary + scale(TIV) + (1|subject), data = hippo_data_long[hippo_data_long$sex==2,])
summary(mod_simple)
plot_model(mod_simple, type= "int")


mod_simpleA0<-lmer(vol_Whole_hippocampus ~ kids_total*diff_mri + age_v1 +APOE_binary + scale(TIV) + (1|subject), data = hippo_data_long[hippo_data_long$sex==2&hippo_data_long$A == 0,])
summary(mod_simpleA0)

mod_simpleA1<-lmer(vol_Whole_hippocampus ~ kids_total*diff_mri + age_v1 +APOE_binary + scale(TIV) + (1|subject), data = hippo_data_long[hippo_data_long$sex==2&hippo_data_long$A == 1,])
summary(mod_simpleA1)

emm_A <- emmeans(mod_simple, ~ A,
                 data = hippo_data_long[hippo_data_long$sex==2,])
pairs(emm_A)

emm_int <- emmeans(mod_simple, ~ A | kids_total,
                   at = list(kids_total = c(0, 1, 2, 3, 4)),
                   data = hippo_data_long[hippo_data_long$sex==2,])
pairs(emm_int)

#the group contrast between A+ and A- is significant from 2+ kids 

emm_int <- emmeans(mod_simple, ~ kids_total | A,
                   at = list(kids_total = c(0, 1, 2, 3, 4)),
                   data = hippo_data_long[hippo_data_long$sex==2,])
pairs(emm_int)

#sensitivity analysis female var

mod_simple_fem1<-lmer(vol_Whole_hippocampus ~ kids_total*diff_mri*A + repro_span + age_v1 +APOE_binary + scale(TIV) + (1|subject), data = hippo_data_long[hippo_data_long$sex==2,])
summary(mod_simple_fem1)

mod_simple_fem2<-lmer(vol_Whole_hippocampus ~ kids_total*diff_mri*A + age_menopause_pmm + age_v1 +APOE_binary + scale(TIV) + (1|subject), data = hippo_data_long[hippo_data_long$sex==2,])
summary(mod_simple_fem2)

mod_simple_fem3<-lmer(vol_Whole_hippocampus ~ kids_total*diff_mri*A + HRT + age_v1 +APOE_binary + scale(TIV) + (1|subject), data = hippo_data_long[hippo_data_long$sex==2,])
summary(mod_simple_fem3)

anova(mod_simple, mod_simple_fem1, REML=F)

hippo_data_long%>%
  filter(sex==2)%>%
  drop_na(A)%>%
  ggplot(aes(x=kids_total, y=vol_subiculum, colour=A))+
  geom_point()+
  facet_wrap(~Visit)+
  geom_smooth(aes(group=A), method="lm")
```

## subfields
```{r, echo=FALSE}
hippo_data_long%>%
  filter(sex == 2 )%>%
  dplyr::select(-vol_Whole_hippocampal_body, -vol_Whole_hippocampal_head, -vol_Whole_hippocampus, -`vol_hippocampal-fissure`)%>%
run_volume_lmer_regressions( .,c( "kids_total*diff_mri", "age_v1"  ,"APOE_binary","A", "scale(TIV)", "(1 | subject)"))

p_values <- c(0.2839  ,   0.67670   , 0.604591    ,0.4934 ,   0.086665 ,0.697483   , 0.022171 ,0.7787   , 0.87069 ,   0.408 ,   0.507719     )

fdr_adjusted_p_values <- p.adjust(p_values, method = "fdr")
fdr_adjusted_p_values

#fimbria significant but does not survive

##interaction

hippo_data_long%>%
  filter(sex == 2 )%>%
  dplyr::select(-vol_Whole_hippocampal_body, -vol_Whole_hippocampal_head, -vol_Whole_hippocampus, -`vol_hippocampal-fissure`)%>%
run_volume_lmer_regressions( .,c( "kids_total*A*diff_mri" ,"age_v1", "APOE_binary", "scale(TIV)", "(1 | subject)"))

p_values <- c(0.65234  ,  0.084370, 0.015109, 0.0284 ,0.413253  ,  0.105757   , 0.927819    ,0.6756  ,  0.00188, 0.00926 ,0.021231 )

fdr_adjusted_p_values <- p.adjust(p_values, method = "fdr")
fdr_adjusted_p_values

#CA4, GC-ML-DG, subiculum and presubiculum near significant interaction between kids and A; sig for parasubiculum. no 3 way interaction with time, or effect of time.

#need to check the effect per A group; then can adjust 

mod_hip<-lmer(vol_CA4 ~ kids_total*A*diff_mri +age_v1+ APOE_binary+ scale(TIV)+ (1 | subject), data = hippo_data_long[hippo_data_long$sex==2,])

mod_hip_A0<-lmer(vol_CA4 ~ kids_total*diff_mri +age_v1+ APOE_binary+ scale(TIV)+ (1 | subject), data = hippo_data_long[hippo_data_long$sex==2 & hippo_data_long$A==0,])
summary(mod_hip_A0)

mod_hip_A1<-lmer(vol_CA4 ~ kids_total*diff_mri +age_v1+ APOE_binary+ scale(TIV)+ (1 | subject), data = hippo_data_long[hippo_data_long$sex==2 & hippo_data_long$A==1,])
summary(mod_hip_A1)
#presubiculum, subiculum, DG, CA4 mainly driven by A- women
#parasubiculum driven by A+ women

emm_A <- emmeans(mod_hip, ~ A,
                 data = hippo_data_long[hippo_data_long$sex==2,])
pairs(emm_A)

emm_int <- emmeans(mod_hip, ~ A | kids_total,
                   at = list(kids_total = c(0, 1, 2, 3, 4)),
                   data = hippo_data_long[hippo_data_long$sex==2,])
pairs(emm_int)

#the group contrast between A+ and A- is significant from 2+ kids 

emm_int <- emmeans(mod_hip, ~ kids_total | A,
                   at = list(kids_total = c(0, 1, 2, 3, 4)),
                   data = hippo_data_long[hippo_data_long$sex==2,])
pairs(emm_int)

#no significant group contrast between groups of numbers of kids


#sensitivity analysis female var

hippo_data_long%>%
  filter(sex == 2 )%>%
  dplyr::select(-vol_Whole_hippocampal_body, -vol_Whole_hippocampal_head, -vol_Whole_hippocampus, -`vol_hippocampal-fissure`)%>%
run_volume_lmer_regressions( .,c( "kids_total*A*diff_mri" ,"age_mri", "APOE_binary", "age_menopause_pmm","scale(TIV)", "(1 | subject)"))

hippo_data_long%>%
  filter(sex == 2 )%>%
  dplyr::select(-vol_Whole_hippocampal_body, -vol_Whole_hippocampal_head, -vol_Whole_hippocampus, -`vol_hippocampal-fissure`)%>%
run_volume_lmer_regressions( .,c( "kids_total*A*diff_mri" ,"age_mri", "APOE_binary", "repro_span","scale(TIV)", "(1 | subject)"))

p_values <- c(0.9118  ,  0.2414  ,  0.0267 ,0.0533, 0.703, 0.2047  ,  0.8419  ,  0.759 ,   0.00234, 0.0117 ,0.0224 )

fdr_adjusted_p_values <- p.adjust(p_values, method = "fdr")
fdr_adjusted_p_values

hippo_data_long%>%
  filter(sex == 2 )%>%
  dplyr::select(-vol_Whole_hippocampal_body, -vol_Whole_hippocampal_head, -vol_Whole_hippocampus, -`vol_hippocampal-fissure`)%>%
run_volume_lmer_regressions( .,c( "kids_total*A*diff_mri" ,"age_mri", "APOE_binary", "repro_span","HRT","scale(TIV)", "(1 | subject)"))

```

# Jack
```{r, echo=FALSE}
jack<-read_excel("G:/My Drive/Data/ALFA+/Jack signature ALFA+/bx_signature_jack_ALFA_PLUS_V1_20231120_20250527_142751.xlsx")%>%
  filter(weighted == "TRUE")%>%
  dplyr::select(-ID, -signature, -weighted)%>%
  pivot_wider(names_from = measurement, values_from = value, names_prefix = "jack_")%>%
  mutate(subject = as.numeric(subject),
         Visit = "V1")

jack2<-read_excel("G:/My Drive/Data/ALFA+/Jack signature ALFA+/bx_signature_jack_ALFA_PLUS_V2_20230518_20250210_114442.xlsx")%>%
  filter(weighted == "TRUE")%>%
  dplyr::select(-ID, -signature, -weighted)%>%
  pivot_wider(names_from = measurement, values_from = value, names_prefix = "jack_")%>%
  mutate(subject = as.numeric(subject),
         Visit = "V2")

jack_data<-bind_rows(jack, jack2)
diff_mri_df<-hippo_data_long%>%
  dplyr::select(subject, diff_mri, Visit)

jack_data_long<-left_join(hippo_data_long, jack_data)%>%
  left_join(., diff_mri_df)
  


fit_jack_cort_w <- lmer(jack_ThickAvg ~ kids_total*A*diff_mri  +age_v1 + APOE_binary + scale(TIV) + (1 | subject) , jack_data_long[jack_data_long$sex==2,]) 
summary(fit_jack_cort_w)

fit_jack_grey_w <- lmer(jack_GrayVol ~ kids_total*A*diff_mri  +age_v1 + APOE_binary + scale(TIV) + (1 | subject) , jack_data_long[jack_data_long$sex==2,]) 
summary(fit_jack_grey_w)

plot_model(fit_jack_grey_w, type= "int")
```


#Mediation test?
need to redo this, but might be complicated since I am now doing a 3 way interaction
I should do mediation with apoe? or SEM modelling?
```{r, echo=FALSE}

# cols<-data_cog_long_composites%>%
#   dplyr::select(subject, Visit, Z_Attention_Composite, Z_Executive_Composite, Z_Memory_Composite, Z_Language_Composite, Z_Visual_Composite, age_cog, time_diff)
# 
# mediation_data<-hippo_data_long%>%
#   mutate(Visit = ifelse(Visit == "V2", "2", "1"))%>%
#   left_join(., cols)%>%
#   drop_na(Z_Language_Composite)%>%
#   drop_na(vol_parasubiculum)
# 
# library(boot)
# #Fit the models
# med_model <- lmer(vol_parasubiculum ~ kids_total * A * time_diff+ age_v1 + APOE_binary + TIV  +(1 | subject), 
#                    data = mediation_data)
#  
# out_model <- lmer(Z_PACC ~ vol_parasubiculum + kids_total * A *time_diff + age_v1 + APOE_binary + TIV  +(1 | subject), 
#                    data = mediation_data)
# 
# # Extract coefficients for indirect effect
# a_coef <- fixef(med_model)["kids_total:A"]  # interaction effect on mediator
# b_coef <- fixef(out_model)["vol_parasubiculum"]  # mediator effect on outcome
# 
# # Point estimate of indirect effect
# indirect_effect <- a_coef * b_coef
# print(paste("Indirect effect:", indirect_effect))
# 
# # For confidence intervals, use parametric bootstrap
# bootstrap_indirect <- function(n_sims = 1000) {
#   # Get variance-covariance matrices
#   vcov_med <- vcov(med_model)
#   vcov_out <- vcov(out_model)
#   
#   # Simulate coefficients
#   a_sims <- rnorm(n_sims, a_coef, sqrt(vcov_med["kids_total:A", "kids_total:A"]))
#   b_sims <- rnorm(n_sims, b_coef, sqrt(vcov_out["vol_parasubiculum", "vol_parasubiculum"]))
#   
#   # Calculate indirect effects
#   indirect_sims <- a_sims * b_sims
#   
#   return(indirect_sims)
# }
# 
# # Get bootstrap distribution
# indirect_boot <- bootstrap_indirect(1000)
# 
# # Calculate confidence intervals
# ci_lower <- quantile(indirect_boot, 0.025)
# ci_upper <- quantile(indirect_boot, 0.975)
# 
# print(paste("95% CI: [", round(ci_lower, 4), ", ", round(ci_upper, 4), "]"))

## Test 
#install.packages("RMediation")
# library(RMediation)
# 
# # Extract coefficients and standard errors
# a_coef <- fixef(med_model)["kids_total:A1"]
# a_se <- sqrt(vcov(med_model)["kids_total:A1", "kids_total:A1"])
# 
# b_coef <- fixef(out_model)["vol_parasubiculum"] 
# b_se <- sqrt(vcov(out_model)["vol_parasubiculum", "vol_parasubiculum"])
# 
# # Test mediation
# mediation_test <- medci(mu.x = a_coef, mu.y = b_coef, 
#                         se.x = a_se, se.y = b_se,
#                         alpha = 0.05, type = "prodclin")
# 
# print(mediation_test)

```


# plots

## Plot aesthetics
this is needed to run the plot code (creates a function used in them)
```{r, echo=FALSE}

call_aesthethics <- function(text_size){
  th <- theme(   panel.grid.major = element_blank(),
                 panel.grid.minor = element_blank(),
                 panel.border = element_blank(),
                 panel.background = element_blank(),
                 axis.line = element_line(linewidth = 0.5),
                 legend.position = 'right',
                 legend.text = element_text(size= text_size, family="Helvetica"),
                 text = element_text(size= text_size, family="Helvetica"),
                 strip.text.x = element_text(size = rel(0.90)),
                 strip.text.y = element_text(size = rel(0.90)),
                 axis.title.x = element_text(vjust=-0.3),
                 plot.title = element_text(hjust = 0.5, vjust = 0),
                 axis.ticks = element_line(linewidth = 0.4),
                 axis.text.x.bottom  = element_text(size = rel(0.90), margin = unit(c(t = 2.5, r = 0, b = 0, l = 0), "mm")),
                 axis.title.y = element_text(vjust = 1),
                 axis.text.y = element_text(size = rel(0.90), margin = unit(c(t = 0, r = 2.5, b = 0, l = 0), "mm")),
                 axis.ticks.length = unit(-1.2, "mm"),
                 axis.text.x.top = element_text(size = rel(0.90), margin = unit(c(t = 0, r = 0, b = 2.5, l = 0), "mm")))
  return(th)
}


th <- call_aesthethics(15)

```



## PACC ~ parity * A * time

```{r, echo=FALSE}

data_figure_diff<-data_cog_long_composites%>%
  dplyr::select(subject, Visit, Z_PACC)%>%
  pivot_wider(names_from = Visit, values_from = Z_PACC, names_prefix = "Z_PACC")%>%
  mutate(diff_Z_PACC = Z_PACC2-Z_PACC1)%>%
  dplyr::select(-Z_PACC1, -Z_PACC2)%>%
  mutate(Visit = "2")

data_figure_cog<-data_cog_long_composites%>%
  dplyr::select(subject, Visit, Z_PACC, kids_total, A, time_diff, sex)%>%
  left_join(., data_figure_diff, join_by(subject, Visit))%>%
  mutate(diff_Z_PACC = ifelse(Visit== "1", 0, diff_Z_PACC))


#initial try with score differences to have 0 as departure

data_figure_cog %>%
  filter(sex == 2, !is.na(A)) %>%
  mutate(kids_total_factor = ifelse(kids_total >= 3, "3+", as.character(kids_total)),
         A = factor(A, levels = c("0", "1"), labels = c("Aβ-", "Aβ+"))) %>%
  ggplot(aes(x = time_diff, y = diff_Z_PACC, color = kids_total_factor)) +
  geom_line(aes(group = subject), alpha = 0.3) +
  geom_smooth(aes(group = kids_total_factor), method = "lm", se = TRUE) +
  facet_wrap(~A) +
  scale_color_manual(values = c("0" = "#8AD9B5", "1" = "#50B88E", "2" = "#047A56", "3+" = "#0A5940")) +
  th +
  labs(x = "Time difference (days)", 
       y = "PACC change from baseline", 
       color = "Number of childbirths")


mod_cog_plot<- lmer(Z_PACC ~ kids_total*A*time_diff +age_v1 + APOE_binary + education +(1 | subject), data_cog_long[data_cog_long$sex == 2,])
preds <- ggpredict(mod_cog_plot, terms = c("time_diff", "kids_total", "A"))

preds_A0<-as.data.frame(preds)%>%
  rename(kids_total_factor = group,
         A=facet)%>%
  filter(A==0)%>%
  filter(kids_total_factor!=3)%>%
  mutate(A = ifelse(A==0, "Aβ-", "Aβ-"),
         kids_total_factor = ifelse(kids_total_factor== 4, "3+", as.character(kids_total_factor)))


preds_A1<-as.data.frame(preds)%>%
  rename(kids_total_factor = group,
         A=facet)%>%
  filter(A==1)%>%
  filter(kids_total_factor!=3)%>%
  mutate(A = ifelse(A==1, "Aβ+", "Aβ+"),
         kids_total_factor = ifelse(kids_total_factor== 4, "3+", as.character(kids_total_factor)))

#by time diff with predicted values - preferred?
data_cog_long_composites %>%
  filter(sex == 2, !is.na(A)) %>%
  mutate(kids_total_factor = ifelse(kids_total >= 3, "3+", as.character(kids_total)),
         A = factor(A, levels = c("0", "1"), labels = c("Aβ-", "Aβ+"))) %>%
  ggplot(aes(x = time_diff, y = Z_PACC, color = kids_total_factor)) +
  geom_point(alpha = 0.3, size=2) +
  geom_line(data =preds_A0, aes(x=x, 
                                y=predicted, 
                                group=kids_total_factor), size=1.3) +
  geom_line(data =preds_A1, aes(x=x, 
                                y=predicted, 
                                group=kids_total_factor), size=1.3) +
  geom_ribbon(data =preds_A0, aes(x=x,  
                                  ymin= conf.low, 
                                  ymax = conf.high, 
                                  group=kids_total_factor), inherit.aes = F, alpha=.07)+
  geom_ribbon(data =preds_A1, aes(x=x,  
                                  ymin= conf.low, 
                                  ymax = conf.high, 
                                  group=kids_total_factor), inherit.aes = F, alpha=.07)+
  facet_wrap(~A) +
  scale_color_manual(values = c("0" = "#8AD9B5", "1" = "#50B88E", "2" = "#047A56", "3+" = "#0A5940")) +
  th +
  labs(x = "Time difference (days)", 
       y = "PACC Z-score", 
       color = "Number of childbirths")



#by visit instead of time

data_cog_long_composites %>%
  filter(sex == 2, !is.na(A)) %>%
  mutate(kids_total_factor = ifelse(kids_total >= 3, "3+", as.character(kids_total)),
         A = factor(A, levels = c("0", "1"), labels = c("Aβ-", "Aβ+"))) %>%
  ggplot(aes(x = kids_total_factor, y = Z_PACC, fill = Visit)) +
  geom_boxplot(position = position_dodge(width = 0.8), alpha = 0.7) +
  facet_wrap(~A) +
  scale_fill_manual(values = c("1" = "#E8F4F8", "2" = "#4A90A4")) +
  th +
  labs(x = "Number of childbirths", 
       y = "PACC Z-score", 
       fill = "Visit") +
  scale_x_discrete(limits = c("0", "1", "2", "3+"))


```



## hipp ~ childbirth*AB

### Boxplot for parasubiculum subfield values per A, parity and visit 

```{r, echo=FALSE}
mod_plot<-lmer(vol_parasubiculum ~ kids_total*A + Visit + as.factor(APOE_binary) + scale(TIV) +(1| subject), data=hippo_data_long[hippo_data_long$sex==2,] )
summary(mod_plot)

plot_model(mod_plot, type= "est", title = "", axis.title = "Parasubiculum volume change model estimate" )

preds <- ggpredict(mod_plot, terms = c("kids_total", "A", "Visit")) 

hippo_data_long %>%
  filter(sex == 2) %>%
  drop_na(A) %>%
  mutate(kids_total_factor=ifelse(kids_total>=3, "3+", kids_total))%>%
  mutate(A = factor(A, labels = c("Aβ-", "Aβ+"))) %>%
  ggplot(aes(x = Visit, y = vol_parasubiculum, color = kids_total_factor, fill=kids_total_factor)) +
  geom_point(alpha = 0.6, 
             position = position_dodge(width = 1)) +
  geom_boxplot(position = position_dodge(width = 0.9), 
               alpha=.5)+
  facet_wrap(~A) +
  th +
  labs(x = "Visit", 
       y = "Parasubiculum volume", 
       color = "Number of childbirths", 
       fill= "Number of childbirths")+
  scale_color_manual(values = c("0" = "lightblue", "1" = "steelblue", "2" = "darkblue", "3+" = "navy", "4" = "midnightblue")) +
  scale_fill_manual(values = c("0" = "lightblue", "1" = "steelblue", "2" = "darkblue", "3+" = "navy", "4" = "midnightblue"))+
  scale_x_discrete(expand = expansion(mult = c(0.8, 0.8)))

ggsave("G:/My Drive/ADPD 2026/plot_parasubiculum_interaction.png", width = 9, height = 5)
```

### Boxplot for whole hppocampus values per A, parity and visit 
```{r, echo=FALSE}
#need to add signif stars
hippo_data_long %>%
  filter(sex == 2) %>%
  drop_na(A) %>%
  mutate(kids_total_factor=as.character(kids_total))%>%
  mutate(A = factor(A, labels = c("Aβ-", "Aβ+"))) %>%
  ggplot(aes(x = kids_total_factor, y = vol_Whole_hippocampus, color = A, fill=A)) +
  geom_point(alpha = 0.6, 
             position = position_dodge(width = 1)) +
  geom_boxplot(position = position_dodge(width = 0.9), 
               alpha=.5)+
  facet_wrap(~Visit) +
  th +
  labs(x = "Visit", 
       y = "Hippocampus volume", 
       color = "Number of childbirths", 
       fill= "Number of childbirths")+
  scale_x_discrete(expand = expansion(mult = c(0.3, 0.3)))


ggsave("G:/My Drive/ADPD 2026/plot_whole_hippocampus_interaction.png", width = 9, height = 5)
```



### Forest plot
```{r, echo=FALSE}
data_forest_plot<-hippo_data_long%>%
  filter(sex == 2 )

models<-list(
  CA1 = lmer(vol_CA1 ~ kids_total*A*diff_mri + scale(TIV) + age_v1 + APOE_binary + (1 | subject),data = data_forest_plot),
  CA3 = lmer(vol_CA3 ~ kids_total*A*diff_mri + scale(TIV) + age_v1 + APOE_binary + (1 | subject),data = data_forest_plot),
  `CA4` = lmer(vol_CA4 ~ kids_total*A*diff_mri + scale(TIV) + age_v1 + APOE_binary + (1 | subject),data = data_forest_plot),
  `GC-ML-DG` = lmer(vol_GC_ML_DG ~ kids_total*A*diff_mri + scale(TIV) + age_v1 + APOE_binary + (1 | subject),data = data_forest_plot),
  HATA = lmer(vol_HATA ~ kids_total*A*diff_mri + scale(TIV) + age_v1 + APOE_binary + (1 | subject),data = data_forest_plot),
  Tail = lmer(vol_Hippocampal_tail ~ kids_total*A*diff_mri + scale(TIV) + age_v1 + APOE_binary + (1 | subject),data = data_forest_plot),
  Fimbria = lmer(vol_fimbria ~ kids_total*A*diff_mri + scale(TIV) + age_v1 + APOE_binary + (1 | subject),data = data_forest_plot),
  `Molecular layer` = lmer(vol_molecular_layer_HP ~ kids_total*A*diff_mri + scale(TIV) + age_v1 + APOE_binary + (1 | subject),data = data_forest_plot),
 `Parasubiculum` = lmer(vol_parasubiculum ~ kids_total*A*diff_mri + scale(TIV) + age_v1 + APOE_binary + (1 | subject),data = data_forest_plot),
  `Presubiculum` = lmer(vol_presubiculum ~ kids_total*A*diff_mri + scale(TIV) + age_v1 + APOE_binary + (1 | subject),data = data_forest_plot),
  `Subiculum` = lmer(vol_subiculum ~ kids_total*A*diff_mri + scale(TIV) + age_v1 + APOE_binary + (1 | subject),data = data_forest_plot)
)

# Extract coefficients and CIs
#install.packages("broom.mixed")
library(broom.mixed)
library(purrr)

pred_hippo_all <- map_dfr(models, ~ {
  broom.mixed::tidy(.x, terms = c("kids_total", "A1"))   # Add consistent term column
}, .id = "region")%>%
  filter(term %in% c("kids_total", "A1", "kids_total:A1"))%>%
  dplyr::select(region, term, estimate, std.error)%>%
  pivot_wider(names_from = term, values_from = c(estimate, std.error))%>%
  mutate(plot_estimate_kids_A0 = estimate_kids_total,
         plot_estimate_kids_A1 = estimate_kids_total + `estimate_kids_total:A1`,
         plot_conf.low_kids_A0 = estimate_kids_total - 1.96 * std.error_kids_total,
         plot_conf.high_kids_A0 = estimate_kids_total + 1.96 * std.error_kids_total,
         plot_conf.low_kids_A1 = (estimate_kids_total + `estimate_kids_total:A1` - 1.96 * `std.error_kids_total:A1`),
         plot_conf.high_kids_A1 = (estimate_kids_total + `estimate_kids_total:A1` + 1.96 * `std.error_kids_total:A1`))%>%
  dplyr::select(-estimate_kids_total, -estimate_A1,-`estimate_kids_total:A1` ,-`std.error_kids_total`, -std.error_A1 ,         -`std.error_kids_total:A1`)%>%
  pivot_longer(
    cols = starts_with("plot_"),  # Keep 'term' as-is
    names_to = c(".value", "A"),  # .value creates columns like estimate, conf.low, etc.
    names_pattern = "plot_(.*)_kids_A(\\d+)"
  )%>%
  mutate(colour_group = case_when(region == "CA4" ~ "trend",
                                  region == "GC-ML-DG" ~ "trend",
                                  region == "Presubiculum" ~ "trend",
                                  region == "Subiculum" ~ "trend",
                                  region == "Parasubiculum" ~ "significant",
                                  .default = "normal"))



pred_hippo_all %>%
  mutate(A = factor(A, levels = c("1", "0"), labels = c("Positive", "Negative"))) %>%
  ggplot(aes(x = estimate, y = region, group = A, shape = A, color = colour_group)) +
  geom_pointrange(aes(xmin = conf.low, xmax = conf.high), 
                  position = position_dodge(width = 0.8),
                  size = 0.6) +
  labs(x = "Estimated effect of parity", 
       y = "Hippocampal subfield", 
       shape = "Aβ status",
       color = "Significance level (FDR corrected)") +
  th +
  geom_vline(xintercept = 0, linetype = "dotted", colour = "grey3") +
  scale_shape_manual(values = c("Negative" = 15, "Positive" = 16))+
  scale_color_manual(values = c("trend" = "grey3", "significant" = "red", "normal" = "grey48"))+
  guides(colour = "none")
  


ggsave("G:/My Drive/ADPD 2026/plot_all_regressions_estimates.png", width = 8, height = 6)
```
### time difference plots for whole hipp and subfields?

```{r}
mod_hip_plot<- lmer(vol_Whole_hippocampus ~ kids_total*A*diff_mri +age_v1 + APOE_binary  +(1 | subject), hippo_data_long[hippo_data_long$sex == 2,])
preds <- ggpredict(mod_hip_plot, terms = c("diff_mri", "kids_total", "A"))

preds_A0<-as.data.frame(preds)%>%
  rename(kids_total_factor = group,
         A=facet)%>%
  filter(A==0)%>%
  mutate(A = ifelse(A==0, "Aβ-", "Aβ-"),
         kids_total_factor = ifelse(kids_total_factor == 4, "4+", as.character(kids_total_factor)))


preds_A1<-as.data.frame(preds)%>%
  rename(kids_total_factor = group,
         A=facet)%>%
  filter(A==1)%>%
  mutate(A = ifelse(A==1, "Aβ+", "Aβ+"),
         kids_total_factor = ifelse(kids_total_factor == 4, "4+", as.character(kids_total_factor)))


hippo_data_long %>%
  filter(sex == 2, !is.na(A)) %>%
  mutate(kids_total_factor = ifelse(kids_total == 4, "4+", as.character(kids_total)),
         A = factor(A, levels = c("0", "1"), labels = c("Aβ-", "Aβ+"))) %>%
  ggplot(aes(x = diff_mri, y = vol_Whole_hippocampus, color = kids_total_factor)) +
  geom_line(data =preds_A0, aes(x=x, 
                                y=predicted, 
                                group=kids_total_factor), size=1.3) +
  geom_line(data =preds_A1, aes(x=x, 
                                y=predicted, 
                                group=kids_total_factor), size=1.3) +
  geom_ribbon(data =preds_A0, aes(x=x,  
                                  ymin= conf.low, 
                                  ymax = conf.high, 
                                  group=kids_total_factor), inherit.aes = F, alpha=.07)+
  geom_ribbon(data =preds_A1, aes(x=x,  
                                  ymin= conf.low, 
                                  ymax = conf.high, 
                                  group=kids_total_factor), inherit.aes = F, alpha=.07)+
  facet_wrap(~A) +
  scale_color_manual(values = c("0" = "#8AD9B5", "1" = "#50B88E", "2" = "#047A56", "3" = "#0A5940", "4+" = "#0F3F2D")) +
  th +
  labs(x = "Time difference (years)", 
       y = "Whole hippocampus", 
       color = "Number of childbirths")

ggsave("G:/My Drive/ADPD 2026/whole_hippocampus_time_diff_modonly.png", width = 8, height = 6)
```


#Table

```{r, echo=FALSE}
library(gtsummary)
library(gt)


data_table<-data_desc%>%
  mutate(TIV_cm=TIV/100)%>%
  filter(sex == "2")%>%
  dplyr::select(age_v1, kids_total, A, APOE_binary, TIV_cm, diff_mri)%>%
  mutate(A=factor(A),
         APOE_binary=factor(APOE_binary))
 

desc_table<-tbl_summary(data_table,
            by = kids_total, 
            missing = "no",
            label= list(kids_total = "Number of childbirths",
                     A= "Aβ status, Count (%)",
                     APOE_binary = "APOE-E4 carrier, Count (%)",
                     age_v1 = "Age at first visit, Mean (SD)",
                     TIV_cm = "Total Intracranial Volume (cm3), Mean (SD)",
                     diff_mri = "Time between visits (years), Mean (SD)"))%>%
  add_n()%>%
  add_p%>%
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels()

desc_table


desc_table%>%
  as_gt()%>%
  gtsave(filename = "G:/My Drive/ADPD 2026/table.png")
#modify the total number of participants depending on availability of T1 and PACC difference
```




#Abstract

Objectives: Little is known about the impact of pregnancy on Alzheimer’s Disease (AD) trajectory. We examined the impact of parity and AD pathology on hippocampal volume trajectory and cognitive performance in cognitively unimpaired (CU) post-menopausal women at risk of AD.

```{r, echo=F}

pt_number<-data%>%
  drop_na(age_v2_mri)%>%
    drop_na(A)%>%
  nrow()%>%
  as.numeric()
  
pt_number_women<-data%>%
  drop_na(age_v2_mri)%>%
    drop_na(A)%>%
  filter(sex==2)%>%
  nrow()%>%
  as.numeric()



```

Methods: We included `r pt_number_women` CU postmenopausal women from the ALFA+ study (Table 1) who completed two longitudinal visits. Hippocampus subfield segmentation was obtained using Freesurfer7. Amyloid (Aβ) positivity was defined as CSF Aβ42/40 ratio<0.071. Cognition was evaluated using PACC and the following composites: attention, memory, executive, language, and visual processing. Parity was defined as number of childbirths. We examined the impact of parity on cognition and then included interaction with Aβ status, via linear mixed longitudinal models. We then assessed parity’s effect on hippocampal subfield volume, also including Aβ status interaction. All models include time interaction. APOE-ε4 carriership and age at each visit were used as covariates, with total intracranial volume when appropriate. FDR correction was applied. 

Results: Parity did not show a significant positive main effect on whole hippocampal volume. A significant parity * Aβ status interaction was found where Aβ+ women with higher parity showed smaller volumes (Figure 1). This interaction was significant in the parasubiculum (adj.p.=0.020), and trending in the CA4 (adj.p=0.055), dentate gyrus (adj.p=0.062), presubiculum (adj.p=0.051) and subiculum (adj.p=0.058) (Figure 2). A significant parity * Aβ status * time was found in PACC score (p=0.033), where Aβ- women with higher parity showed stronger practice effect over time (Figure ?). 

Conclusion: In CU post-menopausal women at risk of AD, parity interacts with AD pathology to influence hippocampus volume durably. Parity and AD pathology interact to impact cognition longitudinally. These findings suggest that reproductive history may interact with AD neuro and cognitive pathology. 

```{r}
#stop("Script stopped here intentionally")
```


# Miscellaneous

## Pati code for PLS

```{r, eval=FALSE}
diff_mri_df_short<-diff_mri_df%>%
  filter(Visit=="V2")%>%
  dplyr::select(-Visit)

dataset_pls<-hippo2%>%
  rename_with(~ paste(., "V2", sep = "_"))%>%
  rename(subject = subject_V2)%>%
  right_join(., hippo, join_by(subject))%>%
  dplyr::select(-Visit, -Visit_V2)%>%
  left_join(., diff_mri_df_short)%>%
  mutate(rate_CA1 = (vol_CA1_V2-vol_CA1)/diff_mri,
         rate_CA3 = (vol_CA3_V2-vol_CA3)/diff_mri,
         rate_CA4 = (vol_CA4_V2-vol_CA4)/diff_mri,
         rate_GC_ML_DG = (vol_GC_ML_DG_V2-vol_GC_ML_DG)/diff_mri,
         rate_HATA = (vol_HATA_V2-vol_HATA)/diff_mri,
         rate_Hippocampal_tail = (vol_Hippocampal_tail_V2-vol_Hippocampal_tail)/diff_mri,
         rate_fimbria = (vol_fimbria_V2-vol_fimbria)/diff_mri,
         rate_molecular_layer_HP = (vol_molecular_layer_HP_V2-vol_molecular_layer_HP)/diff_mri,
         rate_parasubiculum = (vol_parasubiculum_V2-vol_parasubiculum)/diff_mri,
         rate_presubiculum = (vol_presubiculum_V2-vol_presubiculum)/diff_mri,
         rate_subiculum = (vol_subiculum_V2-vol_subiculum)/diff_mri)%>%
  dplyr::select(-c(starts_with("vol_")))
  
dataset_pls_all<-dataset_pls%>%
  right_join(., data)



# Create a single data frame
pls_data <- data.frame(
  dataset_pls_all[, c("age_menopause_pmm", "age_menarche", "HRT", "cause_menopause")],
  dataset_pls_all[, grep("^rate_", colnames(dataset_pls_all))]
)

# Get column names
y_cols <- grep("^rate_", colnames(pls_data), value = TRUE)
x_cols <- c("age_menopause_pmm", "age_menarche", "HRT", "cause_menopause")

# Create the formula string
formula_str <- paste("cbind(", paste(y_cols, collapse = ", "), ") ~ ", 
                    paste(x_cols, collapse = " + "))
pls_formula <- as.formula(formula_str)

set.seed(123)
pls_model <- plsr(pls_formula, data = pls_data, scale = TRUE, validation = "CV")

coef(pls_model)

# predictor loadings: which female health variables drive components
loadings(pls_model)

# outcome loadings: which brain regions are influenced by those components
Yloadings(pls_model)

# cross-validation plot: helps pick number of components
plot(RMSEP(pls_model), legendpos = "topright")
validationplot(pls_model, val.type = "RMSEP") 


par(mfrow=c(2,2))
for(i in 1:min(4, pls_model$ncomp)) {
  loadings_comp <- pls_model$loadings[,i]
  barplot(loadings_comp, main = paste("Component", i, "- Brain Region Loadings"),
          las = 2, cex.names = 0.8, col = ifelse(loadings_comp > 0, "red", "blue"))
  abline(h = 0, lty = 2)
}

loadings_matrix <- as.matrix(pls_model$loadings[,1:min(4, pls_model$ncomp)])
heatmap(loadings_matrix, main = "PLS Loadings Heatmap", 
        scale = "none", col = colorRampPalette(c("blue", "white", "red"))(100))

y_loadings <- Yloadings(pls_model)
heatmap(y_loadings, 
        main = "Y-Loadings Heatmap", 
        xlab = "PLS Components", ylab = "Brain Regions",
        scale = "none", 
        col = colorRampPalette(c("blue", "white", "red"))(100),
        margins = c(8, 12))
```


## test for model estimates of cognition?
```{r, eval=FALSE}
data_forest_plot_cog<-mediation_data%>%
  filter(sex == 2 )

models<-list(
  Attention = lmer(Z_Attention_Composite ~ kids_total*A +age_cog + APOE_binary + education  + Fuma2 +(1 | subject), data_cog_long_composites[data_cog_long_composites$sex == 2,]),
  Memory = lmer(Z_Memory_Composite ~ kids_total*A +age_cog + APOE_binary + education + Fuma2 + (1 | subject), data_cog_long_composites[data_cog_long_composites$sex == 2,]),
  Executive = lmer(Z_Executive_Composite ~ kids_total*A +age_cog + APOE_binary + education + Fuma2 + (1 | subject), data_cog_long_composites[data_cog_long_composites$sex == 2,]),
  Language = lmer(Z_Language_Composite ~ kids_total*A +age_cog + APOE_binary + education + Fuma2 + (1 | subject), data_cog_long_composites[data_cog_long_composites$sex == 2,]),
  Visual = lmer(Z_Visual_Composite ~ kids_total*A +age_cog + APOE_binary + education + Fuma2 + (1 | subject), data_cog_long_composites[data_cog_long_composites$sex == 2,])
)

# Extract coefficients and CIs
#install.packages("broom.mixed")
#library(broom.mixed)
#library(purrr)

pred_cog_all <- map_dfr(models, ~ {
  broom.mixed::tidy(.x, terms = c("kids_total", "A"))   
}, .id = "cog")%>%
  filter(term %in% c("kids_total", "A", "kids_total:A"))%>%
  dplyr::select(cog, term, estimate, std.error)%>%
  pivot_wider(names_from = term, values_from = c(estimate, std.error))%>%
  mutate(plot_estimate_kids_A0 = estimate_kids_total,
         plot_estimate_kids_A1 = estimate_kids_total + `estimate_kids_total:A`,
         plot_conf.low_kids_A0 = estimate_kids_total - 1.96 * std.error_kids_total,
         plot_conf.high_kids_A0 = estimate_kids_total + 1.96 * std.error_kids_total,
         plot_conf.low_kids_A1 = (estimate_kids_total + `estimate_kids_total:A` - 1.96 * `std.error_kids_total:A`),
         plot_conf.high_kids_A1 = (estimate_kids_total + `estimate_kids_total:A` + 1.96 * `std.error_kids_total:A`))%>%
  dplyr::select(-estimate_kids_total, -estimate_A,-`estimate_kids_total:A` ,-`std.error_kids_total`, -std.error_A ,         -`std.error_kids_total:A`)%>%
  pivot_longer(
    cols = starts_with("plot_"),  # Keep 'term' as-is
    names_to = c(".value", "A"),  # .value creates columns like estimate, conf.low, etc.
    names_pattern = "plot_(.*)_kids_A(\\d+)"
  )%>%
  mutate(colour_group = case_when(region == "CA4" ~ "trend",
                                  region == "GC-ML-DG" ~ "trend",
                                  region == "Presubiculum" ~ "trend",
                                  region == "Subiculum" ~ "trend",
                                  region == "Parasubiculum" ~ "significant",
                                  .default = "normal"))



pred_cog_all %>%
  mutate(A = factor(A, levels = c("1", "0"), labels = c("Positive", "Negative"))) %>%
  ggplot(aes(x = estimate, y = cog, group = A, colour = A)) +
  geom_pointrange(aes(xmin = conf.low, xmax = conf.high), 
                  position = position_dodge(width = 0.8),
                  size = 0.6) +
  labs(x = "Estimated effect of parity on cog trajectory", 
       y = "Cog domain") +
  scale_shape_manual(values = c("Negative" = 15, "Positive" = 16))
  


#ggsave("G:/My Drive/ADPD 2026/plot_all_regressions_estimates.png", width = 8, height = 6)
```

### plotting both timepoints

uglyyy
```{r, eval=FALSE}
hippo_data_long%>%
  filter(sex== 2)%>%
  drop_na(A)%>%
  mutate(A=factor(A))%>%
  ggplot(aes(x=Visit, y=vol_parasubiculum, color = A))+
  geom_violin(size=1.1, position = position_dodge(width = 0.5))+
  geom_line( aes(group = subject), alpha=.2, size=1, position = position_dodge(width = 0.5))+
  geom_point( aes(group = subject), alpha=.2, size=1.3, position = position_dodge(width = 0.5))+
  facet_wrap(~kids_total)
```

### plotting differences
uglyyyy
```{r, eval=FALSE}
#I'm aware how clunky this code is... I was fighting with pivots for a while and getting nowhere. So this is the best I could do for now sorry! 

hippo_data_plot<-hippo
colnames(hippo_data_plot) <- paste(colnames(hippo_data_plot), 'V1', sep = '_')
hippo_data_plot<-hippo_data_plot%>%
  rename(subject = subject_V1)%>%
  dplyr::select(-Visit_V1)

hippo_data_plot2<-hippo2
colnames(hippo_data_plot2) <- paste(colnames(hippo_data_plot2), 'V2', sep = '_')
hippo_data_plot2<-hippo_data_plot2%>%
  rename(subject = subject_V2)%>%
  dplyr::select(-Visit_V2)

hippo_data_plot<-left_join(hippo_data_plot, hippo_data_plot2)

base_names <- names(hippo_data_plot) %>%
  str_subset("^vol_.*_V1$") %>%
  str_remove("_V1$")


for (base in base_names) {
  v1_col <- paste0(base, "_V1")
  v2_col <- paste0(base, "_V2")
  diff_col <- paste0(base, "_diff")
  
  hippo_data_plot[[diff_col]] <- hippo_data_plot[[v2_col]] - hippo_data_plot[[v1_col]]
}

hippo_data_plot<-hippo_data_plot%>%
  dplyr::select(subject, vol_CA1_diff, vol_CA3_diff, vol_CA4_diff, vol_GC_ML_DG_diff, vol_HATA_diff, vol_Hippocampal_tail_diff, vol_Whole_hippocampal_body_diff, vol_Whole_hippocampal_head_diff, vol_Whole_hippocampus_diff, vol_fimbria_diff, vol_molecular_layer_HP_diff, vol_parasubiculum_diff, vol_presubiculum_diff, vol_subiculum_diff)


hippo_data_plot_all <- left_join(data, hippo_data_plot) %>%
  mutate(across(starts_with("vol_"), ~ .x / diff_mri, .names = "{.col}_annual"))


hippo_data_plot_all%>%
  filter(sex==2)%>%
  mutate(A=factor(A))%>%
  drop_na(A)%>%
ggplot(aes(x=kids_total, y=vol_parasubiculum_diff_annual, group=A, colour=A))+
  geom_jitter()+
  geom_smooth(method = "lm")+
  call_aesthethics(15)+
  labs(x = "Number of childbirths", y = "Volume change")
```

## PACC ~ childbirth*AB - not in use anymore because using mixed effect model

```{r, eval=FALSE}

mod_pacc_w<-lm(PACC_diff ~ kids_total*A + A+age_v1 + education + APOE_binary + time_diff, data = data_cog_diff[data_cog_diff$sex==2,])
pred_pacc<-ggpredict(mod_pacc_w, terms=c("kids_total", "A"))


data_cog_diff%>%
  filter(sex == 2)%>%
  drop_na(A)%>%
  ggplot(aes(x=kids_total, y=PACC_diff, group=A, colour=A))+
  geom_jitter(width = 0.1)+
  geom_line(data=pred_pacc, 
            aes( x=x,
                 y=predicted,
                 group=group,
                 colour=group), 
            inherit.aes = F, 
            size=1)+
  geom_ribbon(data = pred_pacc, 
              aes(x=x, 
                  ymin= conf.low, 
                  ymax = conf.high, 
                  group=group), 
              inherit.aes = F, 
              alpha=.2)+
  th+
  labs(x = "Number of childbirths", y = "PACC change (Z-score)", group="Aβ+", colour="Aβ+")+
  geom_hline(yintercept = 0, linetype = "dotted", colour = "grey0")+
  scale_color_manual(values = c("0" = "steelblue2", "1" = "tomato"),
                     labels = c("0" = "Negative", "1" = "Positive"))+
  scale_fill_manual(values = c("0" = "steelblue2", "1" = "tomato"),
                    labels = c("0" = "Negative", "1" = "Positive"))


ggsave("G:/My Drive/ADPD 2026/plot_PACC_interaction.png", width = 8, height = 5)
```

##Cognitive results - LM of change
test
test again
```{r, eval=FALSE}
composites1<-read_excel("G:/My Drive/Data/ALFA+/Cognition/Visit 1 - Cognition Z Scores.xlsx")%>%
  dplyr::select(-Gender, -Age_V1S1, -Years_Edu, -V1S1_dt, -Z_PACC_Composite_1.2._v1 )%>%
  rename(subject = IdParticipante)

composites2<-read_excel("G:/My Drive/Data/ALFA+/Cognition/Visit 2 - Cognition Z Scores.xlsx")%>%
  dplyr::select(-Gender, -Age_V1S1, -Years_Edu, -V1S1_dt, -V2S1_dt, -Z_PACC_Composite_1.2._V2 )%>%
  rename(subject = IdParticipante)

PACC_diff<-read_excel("G:/My Drive/Data/ALFA+/Cognition/PACCv1_to_v3(incomplete).xlsx")%>%
  dplyr::select(IdParticipante, Visit, Z_PACC, FechaResultado)%>%
  rename(subject = IdParticipante)%>%
  mutate(subject = as.numeric(subject))%>%
  filter(Visit != 3)%>%
  pivot_wider(names_from = Visit, values_from = c(Z_PACC, FechaResultado))%>%
  mutate(PACC_diff = Z_PACC_2 - Z_PACC_1,
         time_diff = as.numeric(difftime(FechaResultado_2, FechaResultado_1, units= c("days"))))%>%
  dplyr::select(subject, PACC_diff, time_diff)

composite_all_diff<-full_join(composites1, composites2)%>%
  mutate(diff_Attention = Z_Attention_Composite_V2 - Z_Attention_Composite_v1,
         diff_Memory = Z_Memory_Composite_V2 - Z_Memory_Composite_v1,
         diff_Executive = Z_Executive_Composite_V2 - Z_Executive_Composite_v1,
         diff_Language = Z_Language_Composite_V2 - Z_Language_Composite_v1,
         diff_Visual = Z_Visual_Composite_V2 - Z_Visual_Composite_v1,
         subject = as.numeric(subject))%>%
  dplyr:: select(subject, diff_Attention, diff_Memory, diff_Executive, diff_Language, diff_Visual)

data_cog_diff<-left_join(data, composite_all_diff)%>%
  left_join(., PACC_diff)%>%
  mutate(A=factor(A),
         APOE_binary=factor(APOE_binary),
         AT=factor(AT))

mod_pacc_w<-lm(PACC_diff ~ kids_total*A +age_v1 + education + APOE_binary + time_diff, data = data_cog_diff[data_cog_diff$sex==2,])
summary(mod_pacc_w)

tidy_mod1_es<-tidy(mod_pacc_w)$estimate
tidy_mod1_p<-tidy(mod_pacc_w)$p.value


hist(data_cog_diff$PACC_diff)

plot_model(mod_pacc_w, type = "int")

#trying with poly
mod_pacc_w_poly<-lm(PACC_diff ~ poly(kids_total, 2, raw = TRUE)*A+ age_menopause_pmm +age_v1 + education + APOE_binary + time_diff, data = data_cog_diff[data_cog_diff$sex==2,])
summary(mod_pacc_w_poly)
```


## test multivariate MEM
multivariate MEM test
interesting time interaction with ptau217
```{r, eval=FALSE}

test_longer<- data_cog_long_composites%>%
  dplyr::select(-Z_aWMS_DR_RS, -Z_FCSRTI_RT, -Z_FS_totalcnswr, -Z_Wclave_totalscr)%>%
  pivot_longer(cols = starts_with("Z_"), names_to = "cog_domain", values_to = "cog_score")%>%
  mutate(cog_domain = factor(cog_domain))

fit_cog_domain_test<-lmer(cog_score ~ kids_total*A +age_cog + cog_domain + APOE_binary + education + (1 | subject), test_longer[test_longer$sex == 2,])
summary(fit_cog_domain_test)

fit_cog_domain_test<-lmer(cog_score ~ kids_total*CSF_pTau217*time_diff +age_v1 + cog_domain + APOE_binary + education + (1 | subject), test_longer[test_longer$sex == 2,])
summary(fit_cog_domain_test)


plot_model(fit_cog_domain_test, type= "int")


```

## Executive ~ parity * A

```{r, eval=FALSE}
data_cog_long_composites%>%
  filter(sex==2)%>%
  drop_na(A)%>%
  mutate(kids_total_factor=ifelse(kids_total>=3, "3+", kids_total))%>%
  mutate(A = factor(A, levels = c("0", "1"), labels = c("Aβ-", "Aβ+")))%>%
  ggplot(aes(x= Visit, y = Z_Executive_Composite, group = interaction(Visit, kids_total_factor), color= kids_total_factor, fill= kids_total_factor))+
  geom_point(alpha=.6, position = position_dodge(width = 1))+
  geom_boxplot(position = position_dodge(width = 0.9), 
               alpha=.5)+
  facet_wrap(~A)+
  scale_color_manual(values = c("0" = "#8AD9B5", "1" = "#50B88E", "2" = "#047A56", "3+" = "#0A5940")) +
  scale_fill_manual(values = c("0" = "#8AD9B5", "1" = "#50B88E", "2" = "#047A56", "3+" = "#0A5940"))+
   th +
  labs(x = "Visit", 
       y = "Executive composite Z-score", 
       color = "Number of childbirths", 
       fill= "Number of childbirths")


ggsave("G:/My Drive/ADPD 2026/plot_executive.png", width = 9, height = 5)
```

### Individual model forest plot
```{r, eval=FALSE}
plot_model(mod_plot, 
           type = "est", 
           title=" ", 
           axis.labels = c("Childbirths*Aβ+", "TIV", "APOE-ε4 carrier", "Visit", "Aβ+", "Number of childbirths")) + 
  th+
  labs(y = "Parasubiculum volume change model estimate")+
  geom_pointrange(aes(y = estimate, 
                      ymin = conf.low, 
                      ymax = conf.high),
                  size = 0.8)
 
ggsave("G:/My Drive/ADPD 2026/plot_parasubiculum_estimation.png", width = 8, height = 5)
```
